<!-- templates/cad_hub/analysis/batch_analyze.html - Bootstrap 5 -->
{% extends "cad_hub/base_cad.html" %}

{% block title %}Batch-Analyse - CAD Hub{% endblock %}

{% block content %}
<!-- Header -->
<div class="row align-items-center mb-4">
    <div class="col">
        <h2 class="h4 fw-bold mb-1"><i class="bi bi-collection text-info"></i> Batch-Analyse</h2>
        <p class="text-muted mb-0">Mehrere CAD-Dateien gleichzeitig analysieren</p>
    </div>
    <div class="col-auto">
        <a href="{% url 'ifc:analysis_dashboard' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Zurück
        </a>
    </div>
</div>

<div class="row">
    <!-- Upload Area -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-upload"></i> Dateien hochladen</h6>
            </div>
            <div class="card-body">
                <div id="drop-zone" class="border border-2 border-dashed rounded p-4 text-center bg-light">
                    <i class="bi bi-files fs-1 text-muted d-block mb-2"></i>
                    <p class="mb-2">Mehrere Dateien hierher ziehen oder auswählen</p>
                    <input type="file" id="file-input" class="d-none" multiple accept=".ifc,.dxf,.dwg,.igs,.iges,.fbx,.gltf,.glb,.3mf,.ply">
                    <button type="button" class="btn btn-info" onclick="document.getElementById('file-input').click()">
                        <i class="bi bi-folder2-open"></i> Dateien auswählen
                    </button>
                </div>
                
                <!-- Ausgewählte Dateien -->
                <div id="file-list" class="mt-3 d-none">
                    <h6 class="mb-2">Ausgewählte Dateien:</h6>
                    <ul class="list-group" id="selected-files"></ul>
                    <div class="mt-3">
                        <button type="button" class="btn btn-info" id="start-btn" onclick="startAnalysis()">
                            <i class="bi bi-play-fill"></i> Analyse starten
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFiles()">
                            <i class="bi bi-x"></i> Leeren
                        </button>
                    </div>
                </div>
                
                <!-- Progress -->
                <div id="batch-progress" class="mt-3 d-none">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="progress-text">Analysiere...</span>
                        <span id="progress-count">0/0</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ergebnisse -->
        <div id="results-section" class="d-none">
            <!-- Zusammenfassung -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col">
                            <div class="h2 fw-bold text-primary" id="total-count">0</div>
                            <small class="text-muted">Gesamt</small>
                        </div>
                        <div class="col">
                            <div class="h2 fw-bold text-success" id="success-count">0</div>
                            <small class="text-muted">Erfolgreich</small>
                        </div>
                        <div class="col">
                            <div class="h2 fw-bold text-danger" id="failed-count">0</div>
                            <small class="text-muted">Fehlgeschlagen</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Einzelergebnisse -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-list-ul"></i> Einzelergebnisse</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Status</th>
                                    <th>Datei</th>
                                    <th>Format</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="results-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Unterstützte Formate -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-file-earmark"></i> Unterstützte Formate</h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-1">
                    {% for ext in supported_extensions %}
                    <span class="badge bg-light text-dark">{{ ext }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Letzte Batches -->
        {% if recent_batches %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Letzte Batch-Analysen</h6>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for batch in recent_batches %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ batch.total }} Dateien</span>
                        <span>
                            <span class="badge bg-success">{{ batch.successful }}</span>
                            {% if batch.failed > 0 %}
                            <span class="badge bg-danger">{{ batch.failed }}</span>
                            {% endif %}
                        </span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
let selectedFiles = [];

document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    
    // Drag & Drop
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-info');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-info');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-info');
        addFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', (e) => {
        addFiles(e.target.files);
    });
});

function addFiles(files) {
    for (let file of files) {
        if (!selectedFiles.find(f => f.name === file.name)) {
            selectedFiles.push(file);
        }
    }
    updateFileList();
}

function updateFileList() {
    const listEl = document.getElementById('selected-files');
    const fileListDiv = document.getElementById('file-list');
    
    if (selectedFiles.length === 0) {
        fileListDiv.classList.add('d-none');
        return;
    }
    
    fileListDiv.classList.remove('d-none');
    listEl.innerHTML = selectedFiles.map((f, i) => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="bi bi-file-earmark me-2"></i>${f.name}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${i})">
                <i class="bi bi-x"></i>
            </button>
        </li>
    `).join('');
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
}

function clearFiles() {
    selectedFiles = [];
    updateFileList();
    document.getElementById('results-section').classList.add('d-none');
}

async function startAnalysis() {
    if (selectedFiles.length === 0) return;
    
    const formData = new FormData();
    selectedFiles.forEach(f => formData.append('files', f));
    
    document.getElementById('batch-progress').classList.remove('d-none');
    document.getElementById('results-section').classList.add('d-none');
    document.getElementById('start-btn').disabled = true;
    
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressCount = document.getElementById('progress-count');
    
    progressText.textContent = 'Analysiere...';
    progressCount.textContent = `0/${selectedFiles.length}`;
    progressBar.style.width = '50%';
    
    try {
        const response = await fetch('{% url "ifc:batch_analyze_api" %}', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        
        const data = await response.json();
        
        progressBar.style.width = '100%';
        progressBar.classList.remove('progress-bar-animated');
        progressCount.textContent = `${data.total}/${data.total}`;
        progressText.textContent = 'Fertig!';
        
        displayResults(data);
        
    } catch (error) {
        progressText.textContent = 'Fehler: ' + error.message;
        progressBar.classList.add('bg-danger');
    } finally {
        document.getElementById('start-btn').disabled = false;
    }
}

function displayResults(data) {
    document.getElementById('results-section').classList.remove('d-none');
    
    document.getElementById('total-count').textContent = data.total;
    document.getElementById('success-count').textContent = data.successful;
    document.getElementById('failed-count').textContent = data.failed;
    
    const tbody = document.getElementById('results-table');
    tbody.innerHTML = data.results.map(r => `
        <tr>
            <td>
                ${r.success 
                    ? '<i class="bi bi-check-circle text-success"></i>' 
                    : '<i class="bi bi-x-circle text-danger"></i>'}
            </td>
            <td>${r.file_name}</td>
            <td><span class="badge bg-secondary">${(r.format || 'unknown').toUpperCase()}</span></td>
            <td class="small text-muted">
                ${r.success 
                    ? (r.data?.entity_count ? r.data.entity_count + ' Entities' : 'OK')
                    : (r.error || r.errors?.join(', ') || 'Fehler')}
            </td>
        </tr>
    `).join('');
}
</script>
{% endblock %}
